<view class="coupons-container data-v-54b5190c"><view class="header-section data-v-54b5190c"><view class="header-title data-v-54b5190c">优惠券管理</view><view class="header-actions data-v-54b5190c"><button data-event-opts="{{[['tap',[['openBatchModal',['$event']]]]]}}" class="action-btn batch-btn data-v-54b5190c" bindtap="__e">批量发放</button><button data-event-opts="{{[['tap',[['showAddModal',['$event']]]]]}}" class="add-btn data-v-54b5190c" bindtap="__e">发放优惠券</button></view></view><block wx:if="{{selectedUser}}"><view class="stats-section data-v-54b5190c"><view class="stats-grid data-v-54b5190c"><view class="stat-item data-v-54b5190c"><text class="stat-number data-v-54b5190c">{{stats.total}}</text><text class="stat-label data-v-54b5190c">总优惠券</text></view><view class="stat-item data-v-54b5190c"><text class="stat-number data-v-54b5190c">{{stats.unused}}</text><text class="stat-label data-v-54b5190c">未使用</text></view><view class="stat-item data-v-54b5190c"><text class="stat-number data-v-54b5190c">{{stats.used}}</text><text class="stat-label data-v-54b5190c">已使用</text></view><view class="stat-item data-v-54b5190c"><text class="stat-number data-v-54b5190c">{{stats.expired}}</text><text class="stat-label data-v-54b5190c">已过期</text></view></view></view></block><view class="user-filter-section data-v-54b5190c"><view class="user-selector data-v-54b5190c"><text class="section-label data-v-54b5190c">选择用户</text><picker class="user-picker data-v-54b5190c" range="{{userList}}" range-key="nickname" data-event-opts="{{[['change',[['onUserChange',['$event']]]]]}}" bindchange="__e"><view class="picker-display data-v-54b5190c"><text class="data-v-54b5190c">{{selectedUser?selectedUser.nickname+(selectedUser.phone?'（'+selectedUser.phone+'）':''):'请选择用户'}}</text><text class="picker-arrow data-v-54b5190c">▼</text></view></picker></view><view class="user-search data-v-54b5190c"><input class="user-search-input data-v-54b5190c" placeholder="搜索用户手机号" data-event-opts="{{[['confirm',[['onUserSearch',['$event']]]],['input',[['__set_model',['','userKeyword','$event',[]]],['onUserSearchInput',['$event']]]]]}}" value="{{userKeyword}}" bindconfirm="__e" bindinput="__e"/><button data-event-opts="{{[['tap',[['onUserSearch',['$event']]]]]}}" class="search-btn data-v-54b5190c" bindtap="__e">搜索</button><block wx:if="{{userKeyword}}"><button data-event-opts="{{[['tap',[['clearUserSearch',['$event']]]]]}}" class="clear-search-btn data-v-54b5190c" bindtap="__e">清空</button></block></view></view><block wx:if="{{selectedUser}}"><view class="user-info-section data-v-54b5190c"><view class="user-info data-v-54b5190c"><text class="user-name data-v-54b5190c">{{selectedUser.nickname}}</text><text class="user-phone data-v-54b5190c">{{selectedUser.phone}}</text><text class="coupon-count data-v-54b5190c">{{"共 "+$root.g1+" 张优惠券"}}</text></view></view></block><view class="coupons-list data-v-54b5190c"><block wx:for="{{$root.l0}}" wx:for-item="coupon" wx:for-index="index" wx:key="id"><view class="coupon-item data-v-54b5190c"><view class="coupon-header data-v-54b5190c"><view class="coupon-main data-v-54b5190c"><view class="coupon-name data-v-54b5190c">{{coupon.$orig.type+"（面值：¥"+coupon.$orig.value+"）"}}</view><view class="{{['data-v-54b5190c','coupon-status',coupon.m0]}}">{{coupon.m1}}</view></view></view><view class="coupon-details data-v-54b5190c"><view class="detail-row data-v-54b5190c"><text class="detail-label data-v-54b5190c">领取时间：</text><text class="detail-value data-v-54b5190c">{{coupon.m2}}</text></view><block wx:if="{{coupon.$orig.used_at}}"><view class="detail-row data-v-54b5190c"><text class="detail-label data-v-54b5190c">使用时间：</text><text class="detail-value data-v-54b5190c">{{coupon.m3}}</text></view></block></view><view class="coupon-actions data-v-54b5190c"><block wx:if="{{coupon.$orig.status==='unused'}}"><button data-event-opts="{{[['tap',[['showUpgradeModal',['$0'],[[['coupons','id',coupon.$orig.id]]]]]]]}}" class="action-btn upgrade-btn data-v-54b5190c" bindtap="__e">升级</button></block><button data-event-opts="{{[['tap',[['deleteCoupon',['$0'],[[['coupons','id',coupon.$orig.id,'id']]]]]]]}}" class="action-btn delete-btn data-v-54b5190c" bindtap="__e">删除</button></view></view></block></view><block wx:if="{{$root.g2}}"><view class="empty-state data-v-54b5190c"><text class="empty-text data-v-54b5190c">该用户暂无优惠券</text><button data-event-opts="{{[['tap',[['showAddModal',['$event']]]]]}}" class="empty-action-btn data-v-54b5190c" bindtap="__e">立即发放</button></view></block><block wx:if="{{!selectedUser}}"><view class="empty-state data-v-54b5190c"><text class="empty-text data-v-54b5190c">请先选择用户</text></view></block><block wx:if="{{showModal}}"><view data-event-opts="{{[['tap',[['closeModal',['$event']]]]]}}" class="modal-overlay data-v-54b5190c" bindtap="__e"><view data-event-opts="{{[['tap',[['',['$event']]]]]}}" class="modal-content data-v-54b5190c" catchtap="__e"><view class="modal-header data-v-54b5190c"><text class="modal-title data-v-54b5190c">发放优惠券</text><text data-event-opts="{{[['tap',[['closeModal',['$event']]]]]}}" class="modal-close data-v-54b5190c" bindtap="__e">×</text></view><view class="modal-body data-v-54b5190c"><view class="form-group data-v-54b5190c"><text class="form-label data-v-54b5190c">选择用户</text><picker range="{{userList}}" range-key="nickname" data-event-opts="{{[['change',[['onModalUserChange',['$event']]]]]}}" bindchange="__e" class="data-v-54b5190c"><view class="picker-text data-v-54b5190c">{{modalUser?modalUser.nickname+(modalUser.phone?'（'+modalUser.phone+'）':''):'请选择用户'}}</view></picker></view><view class="form-group data-v-54b5190c"><text class="form-label data-v-54b5190c">优惠券类型</text><picker class="form-picker data-v-54b5190c" range="{{couponTypes}}" range-key="label" data-event-opts="{{[['change',[['onTypeChange',['$event']]]]]}}" bindchange="__e"><view class="picker-text data-v-54b5190c">{{couponTypes[typeIndex].label}}</view></picker></view></view><view class="modal-footer data-v-54b5190c"><button data-event-opts="{{[['tap',[['closeModal',['$event']]]]]}}" class="modal-btn cancel-btn data-v-54b5190c" bindtap="__e">取消</button><button data-event-opts="{{[['tap',[['submitGrantCoupon',['$event']]]]]}}" class="modal-btn confirm-btn data-v-54b5190c" bindtap="__e">确定</button></view></view></view></block><block wx:if="{{showUpgrade}}"><view data-event-opts="{{[['tap',[['closeUpgradeModal',['$event']]]]]}}" class="modal-overlay data-v-54b5190c" bindtap="__e"><view data-event-opts="{{[['tap',[['',['$event']]]]]}}" class="modal-content data-v-54b5190c" catchtap="__e"><view class="modal-header data-v-54b5190c"><text class="modal-title data-v-54b5190c">升级优惠券</text><text data-event-opts="{{[['tap',[['closeUpgradeModal',['$event']]]]]}}" class="modal-close data-v-54b5190c" bindtap="__e">×</text></view><view class="modal-body data-v-54b5190c"><view class="form-group data-v-54b5190c"><text class="form-label data-v-54b5190c">新类型</text><picker class="form-picker data-v-54b5190c" range="{{couponTypes}}" range-key="label" data-event-opts="{{[['change',[['onUpgradeTypeChange',['$event']]]]]}}" bindchange="__e"><view class="picker-text data-v-54b5190c">{{couponTypes[upgradeTypeIndex].label}}</view></picker></view></view><view class="modal-footer data-v-54b5190c"><button data-event-opts="{{[['tap',[['closeUpgradeModal',['$event']]]]]}}" class="modal-btn cancel-btn data-v-54b5190c" bindtap="__e">取消</button><button data-event-opts="{{[['tap',[['submitUpgradeCoupon',['$event']]]]]}}" class="modal-btn confirm-btn data-v-54b5190c" bindtap="__e">确定</button></view></view></view></block><block wx:if="{{showBatchModal}}"><view data-event-opts="{{[['tap',[['closeBatchModal',['$event']]]]]}}" class="modal-overlay data-v-54b5190c" bindtap="__e"><view data-event-opts="{{[['tap',[['',['$event']]]]]}}" class="modal-content batch-modal data-v-54b5190c" catchtap="__e"><view class="modal-header data-v-54b5190c"><text class="modal-title data-v-54b5190c">批量发放优惠券</text><text data-event-opts="{{[['tap',[['closeBatchModal',['$event']]]]]}}" class="modal-close data-v-54b5190c" bindtap="__e">×</text></view><view class="modal-body data-v-54b5190c"><view class="form-group data-v-54b5190c"><text class="form-label data-v-54b5190c">选择用户（可多选）</text><view class="user-selection-area data-v-54b5190c"><view class="user-list data-v-54b5190c"><block wx:for="{{$root.l1}}" wx:for-item="user" wx:for-index="index" wx:key="id"><view data-event-opts="{{[['tap',[['toggleUserSelection',['$0'],[[['userList','id',user.$orig.id,'id']]]]]]]}}" class="{{['data-v-54b5190c','user-item',[(user.g4)?'selected':'']]}}" bindtap="__e"><view class="user-info data-v-54b5190c"><text class="user-name data-v-54b5190c">{{user.$orig.nickname}}</text><text class="user-phone data-v-54b5190c">{{user.$orig.phone||'无手机号'}}</text></view><view class="selection-indicator data-v-54b5190c"><block wx:if="{{user.g5}}"><text class="selected-icon data-v-54b5190c">✓</text></block></view></view></block></view><view class="selection-summary data-v-54b5190c"><text class="summary-text data-v-54b5190c">{{"已选择 "+$root.g6+" 个用户"}}</text><button data-event-opts="{{[['tap',[['clearUserSelection',['$event']]]]]}}" class="clear-btn data-v-54b5190c" bindtap="__e">清空选择</button></view></view></view><view class="form-group data-v-54b5190c"><text class="form-label data-v-54b5190c">优惠券类型</text><picker class="form-picker data-v-54b5190c" range="{{couponTypes}}" range-key="label" data-event-opts="{{[['change',[['onBatchTypeChange',['$event']]]]]}}" bindchange="__e"><view class="picker-text data-v-54b5190c">{{couponTypes[batchTypeIndex].label}}</view></picker></view></view><view class="modal-footer data-v-54b5190c"><button data-event-opts="{{[['tap',[['closeBatchModal',['$event']]]]]}}" class="modal-btn cancel-btn data-v-54b5190c" bindtap="__e">取消</button><button class="modal-btn confirm-btn data-v-54b5190c" disabled="{{$root.g7===0}}" data-event-opts="{{[['tap',[['submitBatchGrant',['$event']]]]]}}" bindtap="__e">确定发放</button></view></view></view></block></view>